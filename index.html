<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–—ğŸ·åœº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .card-container {
            position: relative; background: #1e293b; border-radius: 6px; overflow: visible; 
            transition: transform 0.2s; aspect-ratio: 2/3.5; 
        }
        .card-container:hover { transform: scale(1.05) translateY(-5px); z-index: 50; }
        .card-img { width: 100%; height: 100%; object-fit: contain; background: #0f172a; border-radius: 6px; }
        .card-selected-mine { border: 2px solid #eab308; box-shadow: 0 0 15px rgba(234,179,8,0.5); z-index: 40; }
        .card-selected-peer { border: 2px solid #ef4444; box-shadow: 0 0 15px rgba(239,68,68,0.5); z-index: 39; }
        .revealed .card-img { opacity: 0.15; } 
        .taken { filter: grayscale(1) brightness(0.6); cursor: not-allowed; }
        .revealed.taken .card-img { opacity: 0.1; }
        .revealed.taken { filter: none; } 
        .danmaku-container { pointer-events: none; overflow: hidden; position: absolute; inset: 0; z-index: 50; }
        .danmaku-item { position: absolute; white-space: nowrap; font-weight: bold; text-shadow: 2px 2px 0 #000; animation: fly 10s linear forwards; }
        @keyframes fly { from { left: 100%; } to { left: -100%; } }
        .rule-modal-backdrop { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); }
        .rule-modal-content { background: #0f172a; border: 1px solid #334155; box-shadow: 0 0 50px rgba(0,0,0,0.9); }
        .btn-disabled { opacity: 0.2; cursor: not-allowed; filter: grayscale(1); pointer-events: none; }
        .zoom-btn { position: absolute; top: 0px; right: 0px; background: rgba(0,0,0,0.6); color: white; width: 30px; height: 30px; border-radius: 0 6px 0 10px; font-size: 16px; display: flex; items-center; justify-content: center; cursor: pointer; z-index: 60; }
        .summary-overlay { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); z-index: 100; }
        .summary-table th { background: #334155; color: #fbbf24; padding: 10px; text-align: left; }
        .summary-table td { border-bottom: 1px solid #334155; padding: 10px; font-family: monospace; }
        .rule-h { font-size: 1.1rem; font-weight: bold; color: #fbbf24; margin-top: 1rem; border-bottom: 1px solid #334155; padding-bottom: 0.2rem; }
        .rule-p { color: #cbd5e1; font-size: 0.9rem; margin-bottom: 0.5rem; line-height: 1.5; }
        .rule-em { color: #60a5fa; font-weight: bold; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans h-screen flex flex-col overflow-hidden">
    
    <div id="rules-modal" class="hidden fixed inset-0 rule-modal-backdrop z-[100] flex items-center justify-center p-4" onclick="toggleRules()">
        <div class="rule-modal-content p-6 md:p-8 rounded-xl max-w-5xl w-full max-h-[85vh] overflow-y-auto relative" onclick="event.stopPropagation()">
            <button onclick="toggleRules()" class="absolute top-4 right-4 text-slate-400 hover:text-white text-2xl">âœ•</button>
            <h2 class="text-3xl font-black text-center text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-red-500 mb-6">æ–—ğŸ·åœºè§„åˆ™</h2>
            <div class="grid md:grid-cols-2 gap-8 text-sm">
                <div>
                    <h3 class="text-xl font-bold text-blue-400 mb-4 border-b-2 border-blue-900 pb-2">é˜²å®ˆæ–¹ç­–ç•¥</h3>
                    <div class="rule-p"><b>ğŸ’°åŸºç¡€èµ„äº§</b><br>åˆå§‹ 10,000 ä»£å¸ã€‚ä»…å¯åˆ†é… 10 ä¸ 100 ä¸¤ç§ã€‚</div>
                    <ul class="list-disc pl-5 rule-p"><li>æ¯è½®éƒ¨ç½²çš„æ€»é‡‘é¢ä¸å¾—å°‘äº 3,000 ä»£å¸ã€‚</li><li>æ‰€æœ‰ç›’å­ä¸å¯ç•™ç©ºã€‚</li><li>ç³»ç»Ÿä¼šæ ¹æ®ä»£å¸æ•°é‡ï¼Œåœ¨å‘æ”»æ–¹å±•ç¤ºæ¨¡ç³Šçš„æ•°é‡åˆ†çº§ã€‚</li></ul>
                    <div class="rule-p"><span class="rule-em">ç­–ç•¥1:ç­‰å·®</span> <br>22 ä¸ªç›’å­çš„ä»£å¸æ€»é‡‘é¢å¿…é¡»æ„æˆä¸€ä¸ªç­‰å·®æ•°åˆ—ã€‚</div>
                    <div class="rule-p"><span class="rule-em">ç­–ç•¥2:ç‰¹å¼‚</span> <br>æ¯ä¸ªç›’å­æ”¾å…¥çš„ä»£å¸å¼ æ•°å®Œå…¨ç›¸åŒã€‚<br>å…¶ä¸­ 21 ä¸ªç›’å­åªè£… 10 å…ƒé¢å€¼ï¼›<br>ä»…æœ‰ 1 ä¸ªç›’å­ è£…å…¥ 100 å…ƒé¢å€¼ã€‚<br>ï¼ˆè¯¥ç›’å­è¢«ç§°ä¸ºâ€œç‰¹æ®Šç¼–å·â€ï¼‰</div>
                    <div class="rule-p"><span class="rule-em">ç­–ç•¥3:å›šçŠ¯</span> <br>22 ä¸ªç›’å­åˆ†åˆ«æ”¾å…¥ 1~22 å¼  10 å…ƒé¢å€¼ä»£å¸<br>ï¼ˆæ•°é‡ä¸ç¼–å·ä¸å¯¹åº”ï¼‰ï¼Œ<br>å¹¶å¯é¢å¤–æŠ•å…¥è‹¥å¹² 100 å…ƒé¢å€¼ã€‚</div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-red-400 mb-4 border-b-2 border-red-900 pb-2">è¿›æ”»æ–¹ç­–ç•¥</h3>
                    <div class="mb-3"><div class="rule-em text-red-400">æ–¹æ¡ˆA:ç›²é€‰ï¼ˆé€šç”¨ï¼‰</div><div class="rule-p">åœ¨ä¸çŸ¥æ™“å…·ä½“é‡‘é¢çš„æƒ…å†µä¸‹ï¼Œä»»é€‰ 8 ä¸ª ç›’å­ã€‚<br>ç›´æ¥è·å¾—é€‰å®šç›’å­å†…çš„å…¨éƒ¨ä»£å¸ã€‚</div></div>
                    <div class="mb-3"><div class="rule-em text-red-400">æ–¹æ¡ˆB:æ¨æ¼”ï¼ˆä»…é™è§„åˆ™ 1 å¯é€‰ï¼‰</div><div class="rule-p">æ¯ç»„å…ˆæŸ¥çœ‹ä¸€ä¸ªç›’å­ï¼Œå†çŒœæµ‹å¦ä¸€ä¸ªç›’å­é‡‘é¢æ¯”å…¶â€œå¤šâ€æˆ–â€œå°‘â€ã€‚<br>å…± 8 æ¬¡ çŒœæµ‹æœºä¼šã€‚<br>è‹¥çŒœä¸­ã€è·å¾—è¯¥ç»„ä¸¤ä¸ªç›’å­çš„å…¨éƒ¨ä»£å¸ã€‚<br>è‹¥çŒœé”™ã€æ— æ³•è·å¾—è¯¥ç»„ä»»ä½•ä»£å¸ã€‚</div></div>
                    <div class="mb-3"><div class="rule-em text-red-400">æ–¹æ¡ˆC:è¿½è¸ªï¼ˆä»…é™è§„åˆ™ 2 å¯é€‰ï¼‰</div><div class="rule-p">æ”»æ–¹çŒœæµ‹â€œç‰¹æ®Šç¼–å·â€çš„å…·ä½“æ•°å­—ï¼Œ<br>ç³»ç»Ÿä¼šç»™å‡ºç›®æ ‡ç¼–å·æ¯”å½“å‰çŒœæµ‹æ˜¯å¤§è¿˜æ˜¯å°ã€‚<br>è‹¥åœ¨ç¬¬ 1ã€2ã€3ã€7ã€8 æ¬¡çŒœä¸­ï¼Œæ å¤ºå…¨éƒ¨ 22 ä¸ªç›’å­çš„ä»£å¸ã€‚<br>è‹¥åœ¨å…¶ä»–è½®æ¬¡çŒœä¸­æˆ–æœªçŒœä¸­ï¼Œæ— æ³•è·å¾—ä»»ä½•ä»£å¸ã€‚</div></div>
                    <div class="mb-3"><div class="rule-em text-red-400">æ–¹æ¡ˆD:åšå¼ˆï¼ˆä»…é™è§„åˆ™ 3 å¯é€‰ï¼‰</div><div class="rule-p">æ”»æ–¹æŒ‡å®šæ•°å­— Xï¼ˆ1-22ï¼‰ï¼ŒéšåæŸ¥çœ‹ 7 ä¸ªç›’å­ã€‚<br>è‹¥å…¶ä¸­åŒ…å«â€œæœ‰ X å¼  10 å…ƒä»£å¸â€çš„ç›’å­ï¼Œåˆ™è§†ä¸ºé˜¶æ®µä¸€æˆåŠŸã€‚<br>ä¹‹åå®ˆæ–¹æŒ‡å®šæ•°å­— Yï¼ˆ1-22ï¼‰ï¼Œæ”»æ–¹å†æ¬¡æŸ¥çœ‹å¦å¤– 7 ä¸ªç›’å­ã€‚<br>è‹¥åŒ…å«â€œæœ‰ Y å¼  10 å…ƒä»£å¸â€çš„ç›’å­ï¼Œåˆ™è§†ä¸ºé˜¶æ®µäºŒæˆåŠŸã€‚<br>æˆåŠŸä¸¤æ¬¡ï¼šè·å¾—å…¨éƒ¨ 22 ä¸ªç›’å­çš„ä»£å¸ã€‚<br>æˆåŠŸä¸€æ¬¡ï¼šè·å¾—ä»»é€‰ 7 ä¸ª ç›’å­çš„ä»£å¸ã€‚<br>å…¨éƒ¨å¤±è´¥ï¼šè·å¾—ä»»é€‰ 5 ä¸ª ç›’å­çš„ä»£å¸ã€‚</div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-login" class="fixed inset-0 flex items-center justify-center bg-slate-900 z-[90]">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl border border-blue-500 w-80 text-center">
            <h1 class="text-3xl font-black text-blue-400 mb-6 italic">TOKEN ARENA</h1>
            <input id="inp-uid" type="text" placeholder="è¾“å…¥ä»£å·" class="w-full bg-slate-700 p-3 rounded mb-4 text-center text-white outline-none focus:ring-2 ring-blue-500">
            <button onclick="toLobby()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded font-bold shadow-lg transition transform active:scale-95">è¿›å…¥æ–—ğŸ·åœº</button>
        </div>
    </div>

    <div id="view-lobby" class="hidden min-h-screen p-4 md:p-8 overflow-y-auto">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-8 border-b border-slate-800 pb-4">
                <h2 class="text-2xl md:text-3xl font-bold text-white">å¤§å… <span id="my-id-tag" class="text-sm font-normal text-slate-500 ml-2"></span></h2>
                <button onclick="createRoom()" class="bg-green-600 hover:bg-green-500 px-4 md:px-6 py-2 rounded-lg font-bold shadow-lg text-sm md:text-base">+ æ–°å»ºå¯¹å±€</button>
            </div>
            <div id="room-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
        </div>
    </div>

    <div id="view-room" class="hidden h-full flex flex-col relative">
        <div class="h-14 md:h-16 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-2 md:px-4 shrink-0 z-40">
            <div class="flex items-center gap-2"> 
                <button id="btn-exit" onclick="exitRoom()" class="text-slate-400 hover:text-white transition px-2 py-1 rounded text-xs md:text-sm">â† é€€å‡º</button>
                <button onclick="toggleRules()" class="bg-slate-700/80 text-white px-2 py-1 rounded-full shadow border border-slate-500 text-xs">ğŸ“œ è§„åˆ™</button>
                <div class="font-mono font-bold text-yellow-500 text-sm md:text-base">ROOM <span id="cur-rid"></span></div>
            </div>
            <div id="timer-display" class="font-mono font-bold text-red-500 text-lg md:text-xl mx-1">05:00</div>
            <div id="game-stats" class="hidden flex gap-2 md:gap-8 font-mono text-xs md:text-sm font-bold bg-slate-800 px-2 py-1 rounded-full border border-slate-700">
                <div class="text-green-400">æˆ‘:<span id="score-self">--</span></div>
                <div class="text-red-400">æ•Œ:<span id="score-opp">--</span></div>
            </div>
        </div>

        <div class="flex-1 flex overflow-hidden relative">
            <div class="flex-1 relative flex flex-col bg-slate-900/50 m-0 md:m-2 md:rounded-xl border-t md:border border-slate-800 overflow-hidden">
                <div id="danmaku-layer" class="danmaku-container"></div>
                
                <div id="prep-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 z-30 p-4">
                    <div id="player-area" class="flex justify-center gap-4 md:gap-8 flex-wrap mb-8 md:mb-12 max-w-4xl"></div>
                    <div class="flex gap-4 w-full justify-center">
                        <button id="btn-ready" onclick="toggleReady()" class="bg-slate-700 hover:bg-slate-600 px-8 py-3 rounded-xl font-bold border-2 border-slate-600 text-lg transition w-full max-w-[150px]">å‡†å¤‡</button>
                        <button id="btn-start" onclick="startGame()" class="hidden bg-yellow-600 hover:bg-yellow-500 text-black px-8 py-3 rounded-xl font-bold shadow-lg text-lg transition animate-bounce w-full max-w-[150px]">å¼€å§‹</button>
                    </div>
                </div>

                <div id="spectator-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-slate-900 z-20 p-4">
                    <h2 class="text-xl font-bold mb-4 text-blue-400">å½“å‰å¯¹å±€ (è§‚æˆ˜ä¸­)</h2>
                    <div id="match-list" class="grid grid-cols-1 gap-2 w-full max-w-md"></div>
                </div>

                <div id="game-board" class="hidden flex-1 flex flex-col p-1 md:p-4 w-full max-w-7xl mx-auto relative overflow-hidden">
                    <div class="flex justify-between items-center mb-1 h-8 shrink-0 px-2">
                        <div class="flex items-center gap-2">
                            <span id="role-tag" class="px-2 py-0.5 rounded text-[10px] md:text-xs font-bold uppercase shadow"></span>
                            <span class="text-slate-400 text-xs">R<span id="ui-round" class="text-white font-bold">1</span></span>
                        </div>
                        <div class="flex gap-1 text-[10px] md:text-xs font-mono">
                            <div id="status-def-rule" class="text-green-500 bg-slate-800 px-2 py-0.5 rounded hidden border border-green-900">å®ˆ:<span id="val-def-rule"></span></div>
                            <div id="status-atk-strat" class="text-red-500 bg-slate-800 px-2 py-0.5 rounded hidden border border-red-900">æ”»:<span id="val-atk-strat"></span></div>
                        </div>
                    </div>
                    <div id="last-msg" class="h-5 text-center text-yellow-400 text-xs font-mono mb-1 truncate shrink-0 px-2"></div>
                    
                    <div id="wait-layer" class="hidden absolute inset-0 top-12 bg-slate-900/80 z-10 flex flex-col items-center justify-center backdrop-blur-sm rounded-lg">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-yellow-500 mb-4"></div>
                        <h2 class="text-lg font-bold text-yellow-500">ç­‰å¾…å¯¹æ‰‹æ“ä½œ...</h2>
                    </div>

                    <div id="panel-defense" class="hidden h-full flex flex-col min-h-0">
                        <div id="def-step-1" class="flex flex-col items-center justify-center h-full space-y-4 overflow-y-auto pb-20">
                            <h3 class="text-xl md:text-3xl font-bold text-green-400 tracking-wider">é€‰æ‹©é˜²å¾¡è§„åˆ™</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 w-full max-w-4xl px-4">
                                <button onclick="lockRule(1)" class="bg-slate-800 p-4 md:p-6 rounded-2xl border border-slate-700 hover:border-green-500 transition text-center"><div class="text-3xl mb-1">ğŸ“</div><div class="font-bold text-base">è§„åˆ™ 1</div></button>
                                <button onclick="lockRule(2)" class="bg-slate-800 p-4 md:p-6 rounded-2xl border border-slate-700 hover:border-green-500 transition text-center"><div class="text-3xl mb-1">ğŸ¯</div><div class="font-bold text-base">è§„åˆ™ 2</div></button>
                                <button onclick="lockRule(3)" class="bg-slate-800 p-4 md:p-6 rounded-2xl border border-slate-700 hover:border-green-500 transition text-center"><div class="text-3xl mb-1">â›“ï¸</div><div class="font-bold text-base">è§„åˆ™ 3</div></button>
                            </div>
                        </div>
                        <div id="def-step-2" class="hidden flex flex-col h-full overflow-hidden relative">
                            <div class="flex-1 overflow-y-auto grid grid-cols-3 md:grid-cols-6 lg:grid-cols-8 gap-2 px-1 p-2 min-h-0 pb-20" id="box-container-def"></div>
                            <div class="shrink-0 p-3 bg-slate-900 border-t border-slate-700 flex justify-between items-center z-20 shadow-[0_-5px_15px_rgba(0,0,0,0.5)]">
                                <div><div class="font-mono text-[10px] text-slate-400">å·²åˆ†é…</div><span id="alloc-val" class="font-bold text-lg font-mono">0</span></div>
                                <button onclick="submitDefense()" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg text-sm">éƒ¨ç½²</button>
                            </div>
                        </div>
                    </div>

                    <div id="panel-attack" class="hidden h-full flex flex-col min-h-0">
                        <div id="atk-step-1" class="flex flex-col items-center justify-center h-full space-y-4 overflow-y-auto pb-20">
                            <div class="text-center"><h3 class="text-xl md:text-3xl font-bold text-red-400 mb-1">ä¾¦æµ‹åˆ°å®ˆæ–¹è§„åˆ™</h3><div id="locked-rule-display" class="text-base text-slate-400 font-mono"></div></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 w-full max-w-3xl px-4">
                                <button id="strat-btn-1" onclick="lockStrat(1)" class="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-red-500 transition text-left"><div class="font-bold text-white text-base">æ–¹æ¡ˆ A</div><div class="text-xs text-slate-500">ç›²é€‰ (10æ¬¡)</div></button>
                                <button id="strat-btn-2" onclick="lockStrat(2)" class="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-red-500 transition text-left"><div class="font-bold text-white text-base">æ–¹æ¡ˆ B</div><div class="text-xs text-slate-500">æ¨æ¼”æ¯”å¤§å°</div></button>
                                <button id="strat-btn-3" onclick="lockStrat(3)" class="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-red-500 transition text-left"><div class="font-bold text-white text-base">æ–¹æ¡ˆ C</div><div class="text-xs text-slate-500">è¿½è¸ªç‰¹å¼‚ç‚¹</div></button>
                                <button id="strat-btn-4" onclick="lockStrat(4)" class="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-red-500 transition text-left"><div class="font-bold text-white text-base">æ–¹æ¡ˆ D</div><div class="text-xs text-slate-500">åšå¼ˆæœå¯»</div></button>
                            </div>
                        </div>
                        <div id="atk-step-2" class="hidden flex flex-col h-full overflow-hidden relative">
                            <div class="flex-1 overflow-y-auto grid grid-cols-3 md:grid-cols-6 lg:grid-cols-8 gap-2 px-1 p-2 min-h-0 pb-20" id="box-container-atk"></div>
                            <div id="action-bar" class="shrink-0 p-3 bg-slate-900 border-t border-slate-700 flex items-center gap-3 z-20 shadow-[0_-5px_15px_rgba(0,0,0,0.5)]">
                                <div id="action-inputs" class="flex-1 flex gap-1 justify-start text-xs text-slate-400 items-center font-mono truncate"></div>
                                <button id="btn-act" class="bg-red-600 hover:bg-red-500 text-white px-5 py-2 rounded-lg font-bold shadow text-sm whitespace-nowrap">æ‰§è¡Œ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chat-panel" class="hidden md:flex w-72 md:w-80 bg-slate-900 border-l border-slate-800 flex-col shrink-0 z-50">
                <div class="p-3 border-b border-slate-800 font-bold text-slate-400 flex justify-between">
                    <span>Chat</span>
                    <button onclick="toggleMobileChat()" class="md:hidden text-slate-500">âœ•</button>
                </div>
                <div id="chat-box" class="flex-1 overflow-y-auto p-3 space-y-2 text-sm"></div>
                <div class="p-3 border-t border-slate-800 flex gap-2">
                    <input id="chat-input" type="text" class="flex-1 bg-slate-800 rounded px-2 py-2 text-white text-sm outline-none focus:ring-1 ring-blue-500" placeholder="å‘é€...">
                    <button onclick="sendChat()" class="bg-blue-600 px-4 py-1 rounded hover:bg-blue-500 text-white">></button>
                </div>
            </div>
            
            <button onclick="toggleMobileChat()" class="md:hidden fixed bottom-20 right-4 w-12 h-12 bg-blue-600 rounded-full shadow-lg z-40 flex items-center justify-center text-white text-xl">ğŸ’¬</button>
        </div>
        
        <div id="summary-view" class="hidden fixed inset-0 summary-overlay flex flex-col items-center justify-center p-4">
            <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] flex flex-col overflow-hidden">
                <div class="p-4 border-b border-slate-700 bg-slate-800 flex justify-between items-center shrink-0">
                    <h2 class="text-2xl font-black text-white">GAME SET</h2>
                    <div class="text-slate-400 text-xs font-mono">è¿”å›: <span id="summary-timer" class="text-yellow-400 font-bold">180</span>s</div>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <table class="w-full text-xs md:text-sm text-slate-300 summary-table">
                        <thead><tr><th>è½®æ¬¡</th><th>å¯¹é˜µ</th><th>è¯¦æƒ…</th><th>ç»“æœ</th><th>å˜åŠ¨</th></tr></thead>
                        <tbody id="summary-tbody"></tbody>
                    </table>
                    <div class="mt-6 grid grid-cols-2 gap-4">
                        <div class="bg-slate-800 p-3 rounded text-center"><div class="text-slate-500 text-xs mb-1">å† å†›</div><div id="final-winner" class="text-xl md:text-3xl font-black text-yellow-500"></div></div>
                        <div class="bg-slate-800 p-3 rounded text-center"><div class="text-slate-500 text-xs mb-1">æˆ‘çš„èµ„äº§</div><div id="final-myscore" class="text-xl md:text-3xl font-bold font-mono text-white"></div></div>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-700 bg-slate-800 flex justify-center shrink-0">
                    <button id="btn-confirm-summary" onclick="confirmSummary()" class="bg-blue-600 hover:bg-blue-500 text-white w-full md:w-auto px-12 py-3 rounded-xl font-bold text-lg shadow-lg">ç¡®è®¤ (<span id="confirm-count">0</span>/<span id="total-players">0</span>)</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="round-transition" class="fixed inset-0 z-[80] bg-black opacity-0 pointer-events-none flex items-center justify-center">
        <div class="text-center transform scale-0 transition-transform duration-500" id="round-modal-inner">
            <h1 class="text-5xl md:text-6xl font-black text-white mb-4 drop-shadow-lg" id="rt-title">ROUND END</h1>
            <div class="text-xl text-yellow-400 font-mono" id="rt-sub"></div>
        </div>
    </div>

    <script>
        const socket = io();
        let myId, myRid, myRole;
        let selectedBoxes = [];
        let peerSelectedBoxes = []; 
        let currentStrat = 0;
        let hasShownRules = false;
        let gameDataCache = {}; 
        let timerInterval = null;
        let summaryTimerInt = null;
        const TAROT_FILES = ["0æ„šè€…","1é­”æœ¯å¸ˆ","2å¥³ç¥­å¸","3çš‡å","4çš‡å¸","5æ•™çš‡","6æ‹äºº","7æˆ˜è½¦","8åŠ›é‡","9éšè€…","10å‘½è¿ä¹‹è½®","11æ­£ä¹‰","12å€’åŠäºº","13æ­»ç¥","14èŠ‚åˆ¶","15æ¶é­”","16é«˜å¡”","17æ˜Ÿæ˜Ÿ","18æœˆäº®","19å¤ªé˜³","20å®¡åˆ¤","21ä¸–ç•Œ"];

        function toggleRules() { document.getElementById('rules-modal').classList.toggle('hidden'); }
        function toggleMobileChat() { 
            const p = document.getElementById('chat-panel');
            if(p.classList.contains('hidden')) {
                p.classList.remove('hidden'); p.classList.add('fixed', 'inset-0', 'z-[100]', 'w-full');
            } else {
                p.classList.add('hidden'); p.classList.remove('fixed', 'inset-0', 'z-[100]', 'w-full');
            }
        }
        function showZoom(src) { Swal.fire({imageUrl: src, imageAlt: 'Card', background: 'transparent', showConfirmButton: false, width: 'auto', padding: 0}); }

        socket.on('connect', () => { const cachedId = localStorage.getItem('hafu_uid'); if(cachedId) { myId = cachedId; socket.emit('reconnect_user', {userId: cachedId}); } });
        socket.on('reconnect_result', data => { if(data.success) { myId = localStorage.getItem('hafu_uid'); document.getElementById('view-login').classList.add('hidden'); document.getElementById('my-id-tag').innerText = `ID: ${myId}`; if(data.msg.includes('é‡è¿')) { document.getElementById('view-lobby').classList.add('hidden'); document.getElementById('view-room').classList.remove('hidden'); } else { document.getElementById('view-lobby').classList.remove('hidden'); socket.emit('enter_lobby', {userId: myId}); } } });
        function toLobby() { myId = document.getElementById('inp-uid').value.trim(); if(!myId) return; localStorage.setItem('hafu_uid', myId); document.getElementById('view-login').classList.add('hidden'); document.getElementById('view-lobby').classList.remove('hidden'); document.getElementById('my-id-tag').innerText = `ID: ${myId}`; socket.emit('enter_lobby', {userId: myId}); }
        function createRoom() { Swal.fire({title:'åˆ›å»ºæˆ¿é—´', input:'text', background:'#1e293b', color:'#fff'}).then(r=>{ if(r.value) socket.emit('create_room', {roomId: r.value, userId: myId}); }); }
        function exitRoom() { socket.emit('leave_room', {roomId: myRid, userId: myId}); }
        socket.on('leave_success', () => { myRid = null; document.getElementById('view-room').classList.add('hidden'); document.getElementById('view-lobby').classList.remove('hidden'); });
        socket.on('lobby_update', rooms => { document.getElementById('room-grid').innerHTML = rooms.map(r => `<div class="bg-slate-800 p-5 rounded-xl border border-slate-700 hover:border-blue-500 transition relative group"><div class="flex justify-between mb-3"><span class="text-white font-bold text-lg">#${r.id}</span><span class="text-xs bg-slate-900 px-2 py-1 rounded text-blue-400">${r.state}</span></div><div class="text-sm text-slate-400 mb-4 flex items-center gap-2">ğŸ‘¤ ${r.count}/10 <span class="text-slate-600">|</span> ğŸ‘‘ ${r.owner}</div><button onclick="socket.emit('join_room',{roomId:'${r.id}',userId:myId})" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold transition">åŠ å…¥</button></div>`).join(''); });
        socket.on('join_success', room => { myRid = room.id; document.getElementById('view-lobby').classList.add('hidden'); document.getElementById('view-room').classList.remove('hidden'); document.getElementById('cur-rid').innerText = myRid; if(room.state === "GAME") { document.getElementById('prep-screen').classList.add('hidden'); document.getElementById('btn-exit').classList.add('hidden'); } else { document.getElementById('prep-screen').classList.remove('hidden'); renderPlayers(room); } if(room.is_spectator) document.getElementById('spectator-screen').classList.remove('hidden'); });
        socket.on('room_sync', renderPlayers);
        function renderPlayers(room) { document.getElementById('player-area').innerHTML = room.players.map(p => `<div class="flex flex-col items-center transform transition hover:scale-110"><div class="w-14 h-14 md:w-16 md:h-16 rounded-2xl flex items-center justify-center font-bold text-xl md:text-2xl border-4 shadow-lg ${room.ready[p]?'bg-green-600 border-green-400 text-white':'bg-slate-800 border-slate-600 text-slate-400'}">${p[0].toUpperCase()}</div><span class="text-xs md:text-sm mt-2 font-mono ${p===myId?'text-yellow-500 font-bold':''}">${p}</span></div>`).join(''); const isOwner = room.owner === myId; const canStart = room.players.length >= 2 && Object.values(room.ready).filter(v=>v).length === room.players.length; document.getElementById('btn-start').classList.toggle('hidden', !(isOwner && canStart)); const btnReady = document.getElementById('btn-ready'); btnReady.innerText = room.ready[myId] ? "å–æ¶ˆ" : "å‡†å¤‡"; btnReady.className = room.ready[myId] ? "bg-red-600 hover:bg-red-500 px-8 py-3 rounded-xl font-bold text-lg transition shadow-lg w-full max-w-[150px]" : "bg-slate-700 hover:bg-slate-600 px-8 py-3 rounded-xl font-bold border-2 border-slate-600 text-lg transition w-full max-w-[150px]"; document.getElementById('btn-exit').classList.remove('hidden'); }
        function toggleReady() { socket.emit('set_ready', {roomId: myRid, userId: myId}); }
        function startGame() { socket.emit('start_game', {roomId: myRid}); }
        function startTimerDisplay(serverTime, deadline) { if(timerInterval) clearInterval(timerInterval); if(!deadline || deadline <= 0) { document.getElementById('timer-display').innerText = "00:00"; return; } const update = () => { let remaining = deadline - serverTime - (Date.now()/1000 - window.clientReceiveTime); if (remaining < 0) remaining = 0; const m = Math.floor(remaining / 60).toString().padStart(2, '0'); const s = Math.floor(remaining % 60).toString().padStart(2, '0'); const el = document.getElementById('timer-display'); el.innerText = `${m}:${s}`; if(remaining < 60) el.classList.add('animate-pulse'); else el.classList.remove('animate-pulse'); }; window.clientReceiveTime = Date.now() / 1000; update(); timerInterval = setInterval(update, 1000); }

        socket.on('game_update', data => {
            const trans = document.getElementById('round-transition');
            trans.style.opacity = 0; trans.style.pointerEvents = 'none';
            document.getElementById('prep-screen').classList.add('hidden');
            document.getElementById('btn-exit').classList.add('hidden');
            document.getElementById('game-stats').classList.remove('hidden');
            if(!hasShownRules) { toggleRules(); hasShownRules = true; }
            
            const role = data.role_info.role;
            myRole = role;
            if (role === 'spectator') {
                 document.getElementById('spectator-screen').classList.add('hidden'); 
                 document.getElementById('game-board').classList.remove('hidden');
            } else {
                 document.getElementById('spectator-screen').classList.add('hidden');
                 document.getElementById('game-board').classList.remove('hidden');
            }
            
            const match = data.match_data;
            if(!match) return; 

            gameDataCache = match.game_data;
            startTimerDisplay(data.server_time, data.round_deadline);
            
            const rTag = document.getElementById('role-tag');
            if(myRole === 'spectator') { rTag.innerText='è§‚æˆ˜ä¸­'; rTag.className='px-2 py-0.5 rounded text-xs font-bold uppercase shadow bg-blue-900 text-blue-300'; }
            else { rTag.innerText = myRole==='defender'?'é˜²å®ˆæ–¹':'è¿›æ”»æ–¹'; rTag.className = `px-2 py-0.5 rounded text-xs font-bold uppercase shadow ${myRole==='defender'?'bg-green-900 text-green-300':'bg-red-900 text-red-300'}`; }
            
            document.getElementById('ui-round').innerText = match.round;
            
            let selfScore = data.scores[myId] || 0;
            let oppScore = 0;
            if (myRole !== 'spectator') {
                const oppId = myRole==='defender' ? match.attacker : match.defender;
                oppScore = data.scores[oppId] || 0;
            } else {
                selfScore = `${data.scores[match.attacker] || 0}(æ”»)`;
                oppScore = `${data.scores[match.defender] || 0}(å®ˆ)`;
                document.getElementById('score-self').parentElement.classList.replace('text-green-400','text-red-400');
                document.getElementById('score-opp').parentElement.classList.replace('text-red-400','text-green-400');
            }
            document.getElementById('score-self').innerText = selfScore; 
            document.getElementById('score-opp').innerText = oppScore;

            document.getElementById('last-msg').innerText = match.game_data.last_msg || "";
            const gd = match.game_data;
            if(gd.rule > 0) document.getElementById('val-def-rule').innerText = `R${gd.rule}`; document.getElementById('status-def-rule').classList.remove('hidden');
            if(gd.strategy > 0) document.getElementById('val-atk-strat').innerText = `S${String.fromCharCode(64+gd.strategy)}`; document.getElementById('status-atk-strat').classList.remove('hidden');
            
            let isReadOnly = true;
            if (gd.step === 'SETUP' && myRole === 'defender') {
                isReadOnly = false;
            } else if (['ATTACK_SELECT', 'ATTACKING'].includes(gd.step) && myRole === 'attacker') {
                isReadOnly = false;
            }

            renderBoard(gd, isReadOnly);
        });
        
        socket.on('sync_selection_ui', data => {
            if (myRole === 'attacker') return;
            peerSelectedBoxes = data.indices;
            const boxes = document.querySelectorAll('#box-container-atk .card-container');
            boxes.forEach((el, i) => {
                const glow = el.querySelector('.box-shadow-glow');
                if (peerSelectedBoxes.includes(i)) {
                    if (!glow) {
                        const div = document.createElement('div');
                        div.className = "absolute inset-0 border-4 border-red-500 rounded z-30 box-shadow-glow card-selected-peer";
                        el.appendChild(div);
                    }
                } else {
                    if (glow) glow.remove();
                }
            });
        });

        function renderBoard(gd, readOnly) {
            const step = gd.step;
            document.getElementById('panel-defense').classList.add('hidden');
            document.getElementById('panel-attack').classList.add('hidden');
            document.getElementById('wait-layer').classList.add('hidden');
            
            if(step === 'SETUP') {
                if(myRole === 'defender' && !readOnly) {
                    document.getElementById('panel-defense').classList.remove('hidden');
                    if(gd.rule === 0) { document.getElementById('def-step-1').classList.remove('hidden'); document.getElementById('def-step-2').classList.add('hidden'); }
                    else { document.getElementById('def-step-1').classList.add('hidden'); document.getElementById('def-step-2').classList.remove('hidden'); if(document.getElementById('box-container-def').innerHTML==="") initDefBoxes(); }
                } else { 
                    document.getElementById('wait-layer').classList.remove('hidden'); 
                    document.getElementById('wait-layer').querySelector('h2').innerText = "ç­‰å¾…é˜²å®ˆæ–¹å¸ƒé˜µ..."; 
                }
            } 
            else if(step === 'ATTACK_SELECT' || step === 'ATTACKING') {
                document.getElementById('panel-attack').classList.remove('hidden');
                
                if(gd.strategy === 0 && !readOnly) {
                    document.getElementById('atk-step-1').classList.remove('hidden'); 
                    document.getElementById('atk-step-2').classList.add('hidden'); 
                    document.getElementById('locked-rule-display').innerText = `è§„åˆ™ ${gd.rule}`;
                    [1,2,3,4].forEach(i => { const btn = document.getElementById(`strat-btn-${i}`); btn.classList.remove('btn-disabled'); if ((i==2 && gd.rule!=1) || (i==3 && gd.rule!=2) || (i==4 && gd.rule!=3)) btn.classList.add('btn-disabled'); });
                } 
                else {
                    if (gd.strategy === 0 && readOnly) {
                        document.getElementById('wait-layer').classList.remove('hidden');
                        document.getElementById('wait-layer').querySelector('h2').innerText = "ç­‰å¾…æ”»æ–¹åˆ¶å®šç­–ç•¥...";
                        document.getElementById('panel-attack').classList.add('hidden');
                    } else {
                        document.getElementById('atk-step-1').classList.add('hidden'); 
                        document.getElementById('atk-step-2').classList.remove('hidden');
                        renderAtkBoxes(gd.public_boxes || gd.boxes, readOnly);
                        currentStrat = gd.strategy;
                        
                        if(readOnly) {
                            document.getElementById('action-bar').classList.add('hidden');
                            if(gd.strategy === 4 && gd.s4.stage === 2 && myRole === 'defender') {
                                document.getElementById('wait-layer').classList.add('hidden'); 
                                if(!window.s4_y_input_shown) { 
                                    window.s4_y_input_shown = true; 
                                    Swal.fire({title:'é˜²å¾¡åå‡»', input:'number', inputLabel:'æ”»æ–¹å·²è¡ŒåŠ¨å®Œæ¯•ï¼Œè¯·è¾“å…¥æ•°å­— Y (1-22) è®©å…¶å¯»æ‰¾', allowOutsideClick:false}).then(r=>{ if(r.value) socket.emit('s4_submit_target', {roomId:myRid, userId:myId, targetNum:r.value}); document.getElementById('wait-layer').classList.remove('hidden'); window.s4_y_input_shown = false; }); 
                                }
                            }
                        } else {
                            if(gd.strategy === 4) handleStratDLogic(gd); else updateActionBtn();
                        }
                    }
                }
            }
        }
        
        function handleStratDLogic(gd) {
            const s4 = gd.s4;
            const btn = document.getElementById('btn-act');
            const inputs = document.getElementById('action-inputs');
            
            if(s4.stage === 0) {
                document.getElementById('wait-layer').classList.add('hidden'); 
                if(!window.s4_x_input_shown) { 
                    window.s4_x_input_shown = true; 
                    Swal.fire({title:'åšå¼ˆå¼€å¯', input:'number', inputLabel:'è¯·è¾“å…¥ç›®æ ‡æ•°å­— X (1-22)', allowOutsideClick:false, allowEscapeKey:false}).then(r=>{ 
                        if(r.value) socket.emit('s4_submit_target', {roomId:myRid, userId:myId, targetNum:r.value}); 
                        window.s4_x_input_shown = false; 
                    }); 
                }
                btn.classList.add('hidden');
            } else if (s4.stage === 1) { 
                updateActionBtn(); 
                inputs.innerText = `ç¬¬ä¸€é˜¶æ®µ: è¯·æ­ç¤º 7 ä¸ª (å·²æ­: ${s4.revealed_phase1.length}/7)`;
            } else if (s4.stage === 2) { 
                document.getElementById('wait-layer').classList.remove('hidden'); 
                document.getElementById('wait-layer').querySelector('h2').innerText = "ç­‰å¾…å®ˆæ–¹è¾“å…¥ Y..."; 
                btn.classList.add('hidden'); 
            } else if (s4.stage === 3) { 
                updateActionBtn();
                inputs.innerText = `ç¬¬äºŒé˜¶æ®µ: è¯·æ­ç¤º 7 ä¸ª (å·²æ­: ${s4.revealed_phase2.length}/7)`;
            } else if (s4.stage === 4) { 
                updateActionBtn(); 
                let count = 5; if(s4.wins === 1) count = 7; if(s4.wins === 2) count = 22;
                inputs.innerText = `ç»“ç®—: æˆåŠŸ ${s4.wins} æ¬¡ï¼Œè¯·æ‹¿ ${count} ä¸ª`;
            }
        }

        function lockRule(r) { socket.emit('lock_rule', {roomId: myRid, userId: myId, rule: r}); }
        function initDefBoxes() { document.getElementById('box-container-def').innerHTML = TAROT_FILES.map((n,i)=>`<div class="bg-slate-800 rounded border border-slate-700 p-1 flex flex-col gap-1"><div class="relative aspect-[2/3] w-full"><img src="/static/cards/${n}.png" class="w-full h-full object-contain bg-slate-900 rounded" onerror="this.src='https://placehold.co/100x150?text=Card'"><div class="zoom-btn" onclick="showZoom(this.previousElementSibling.src)">ğŸ”</div></div><div class="flex items-center gap-1 bg-slate-900 rounded px-1"><span class="text-[10px] text-slate-500 w-4">10</span><input type="number" min="0" class="w-full bg-transparent outline-none text-right inp-c10 text-sm" onchange="checkNeg(this);calcTotal()"></div><div class="flex items-center gap-1 bg-slate-900 rounded px-1"><span class="text-[10px] text-slate-500 w-4">100</span><input type="number" min="0" class="w-full bg-transparent outline-none text-right inp-c100 text-sm" onchange="checkNeg(this);calcTotal()"></div></div>`).join(''); }
        function checkNeg(el){ if(el.value<0) el.value=0; }
        function calcTotal() { let t=0; document.querySelectorAll('.inp-c10').forEach((el,i)=>{ t += (+el.value||0)*10 + (+document.querySelectorAll('.inp-c100')[i].value||0)*100; }); const v=document.getElementById('alloc-val'); v.innerText=t; v.className = t<3000 ? "text-red-500 font-bold text-lg font-mono" : "text-green-400 font-bold text-lg font-mono"; }
        function submitDefense() { const boxes = []; let hasNeg=false; document.querySelectorAll('.inp-c10').forEach((el,i)=>{ let c10=+el.value||0, c100=+document.querySelectorAll('.inp-c100')[i].value||0; if(c10<0||c100<0) hasNeg=true; boxes.push({c10, c100}); }); if(hasNeg) return Swal.fire('é”™è¯¯','ä¸èƒ½ä¸ºè´Ÿ','error'); let total = boxes.reduce((a,b)=>a+b.c10*10+b.c100*100, 0); if(total < 3000) return Swal.fire('é‡‘é¢ä¸è¶³','éƒ¨ç½²é‡‘é¢éœ€è‡³å°‘3000','warning'); socket.emit('submit_defense', {roomId: myRid, userId: myId, boxes}); }
        function lockStrat(s) { socket.emit('select_strategy', {roomId: myRid, userId: myId, strategy: s}); }
        
        function renderAtkBoxes(boxes, readOnly) {
            const container = document.getElementById('box-container-atk');
            container.innerHTML = boxes.map((b,i)=> {
                const isSelectedSelf = selectedBoxes.includes(i);
                const isSelectedPeer = peerSelectedBoxes.includes(i);
                let borderClass = '';
                if(isSelectedSelf) borderClass = 'card-selected-mine'; 
                else if(isSelectedPeer && readOnly) borderClass = 'card-selected-peer'; 
                
                return `
                <div onclick="${readOnly||b.taken||b.revealed?'':'clkBox('+i+')'}" id="b-${i}" class="card-container border border-slate-700 bg-slate-800 flex flex-col items-center relative cursor-pointer group ${b.taken?'taken':''} ${b.revealed?'revealed':''}">
                    <img src="/static/cards/${TAROT_FILES[i]}.png" class="absolute inset-0 w-full h-full object-contain rounded opacity-60 group-hover:opacity-100 transition duration-300">
                    <div class="zoom-btn" onclick="event.stopPropagation();showZoom(this.previousElementSibling.src)">ğŸ”</div>
                    <div class="absolute inset-0 z-20 flex flex-col items-center justify-center pointer-events-none">
                        ${b.revealed ? 
                        `<div class="bg-slate-900/95 p-1 rounded-lg border-2 border-yellow-500 text-xs text-white font-mono shadow-2xl z-50 transform scale-110">
                            <div class="text-green-400 font-bold">10: ${b.real_c10!==undefined?b.real_c10:'?'}</div>
                            <div class="text-red-400 font-bold">100: ${b.real_c100!==undefined?b.real_c100:'?'}</div>
                         </div>` : 
                        `<span class="font-black text-xl drop-shadow-md bg-black/40 px-2 rounded ${['å¤š','è¾ƒå¤š'].includes(b.grade)?'text-red-400':'text-green-400'}">${b.taken?'':b.grade}</span>`}
                    </div>
                    <span class="absolute top-1 left-2 text-xs text-white z-20 font-bold bg-black/50 px-1 rounded">#${i}</span>
                    <div class="absolute inset-0 border-4 rounded z-30 box-shadow-glow ${borderClass} ${isSelectedSelf || (isSelectedPeer&&readOnly) ? '' : 'hidden'}"></div>
                </div>
            `}).join('');
        }
        
        function clkBox(i) {
            if(currentStrat === 3) { Swal.fire({ title: `ç¡®è®¤çŒœæµ‹ #${i}?`, text: "è¿™æ˜¯ç‰¹æ®Šçš„ç›’å­å—ï¼Ÿ", icon: 'question', showCancelButton: true, confirmButtonText: 'ç¡®å®š', cancelButtonText: 'å–æ¶ˆ' }).then(r => { if(r.isConfirmed) socket.emit('execute_attack', {roomId:myRid, userId:myId, guessIdx:i}); }); return; }
            if(currentStrat === 1) { selectedBoxes = [i]; }
            else if (currentStrat === 2) { if (window.s2_step_idx === undefined || window.s2_step_idx === null) { socket.emit('s2_reveal_first', {roomId:myRid, userId:myId, boxId:i}); window.s2_step_idx = i; selectedBoxes = [i]; } else { if (i === window.s2_step_idx) return; selectedBoxes = [window.s2_step_idx, i]; updateActionBtn(); window.s2_step_idx = null; } return; }
            else if (currentStrat === 4) {
                const s4 = gameDataCache.s4;
                if(s4.stage === 1 || s4.stage === 3) { socket.emit('s4_reveal', {roomId:myRid, userId:myId, boxId:i}); return; }
                if(s4.stage === 4) {
                     let maxCount = 5; if(s4.wins === 1) maxCount = 7; if(s4.wins === 2) maxCount = 22;
                     if(selectedBoxes.includes(i)) { selectedBoxes = selectedBoxes.filter(x=>x!==i); } 
                     else { if(selectedBoxes.length < maxCount) selectedBoxes.push(i); else Swal.mixin({toast: true, position: 'top', showConfirmButton: false, timer: 1500}).fire({icon: 'warning', title: `ä¸Šé™ ${maxCount} ä¸ª`}); }
                }
            }
            else { if(selectedBoxes.includes(i)) selectedBoxes=selectedBoxes.filter(x=>x!==i); else selectedBoxes.push(i); }
            
            socket.emit('sync_selection_req', {roomId: myRid, userId: myId, indices: selectedBoxes});
            
            const boxesToRender = gameDataCache.public_boxes || gameDataCache.boxes || [];
            renderAtkBoxes(boxesToRender, false); 
            if(currentStrat === 1 && selectedBoxes.length === 1) { socket.emit('execute_attack', {roomId:myRid,userId:myId,boxId:selectedBoxes[0]}); selectedBoxes = []; }
            updateActionBtn();
        }
        
        function updateActionBtn() {
            const btn = document.getElementById('btn-act'); const inputs = document.getElementById('action-inputs'); const gd = gameDataCache; inputs.innerHTML = '';
            btn.classList.remove('hidden'); btn.disabled = false; btn.innerText = "æ‰§è¡Œ"; btn.className = "bg-red-600 hover:bg-red-500 text-white px-5 py-2 rounded-lg font-bold shadow transition transform active:scale-95 whitespace-nowrap"; btn.onclick = null;

            if(currentStrat===1) { btn.innerText = "å¤„ç†ä¸­..."; btn.disabled = true; } 
            else if(currentStrat===2) { if (selectedBoxes.length === 2) { Swal.fire({ title: 'å†³æ–­æ—¶åˆ»', text: 'åé€‰æ¯”å‰é€‰...', icon: 'question', showDenyButton: true, showCancelButton: false, confirmButtonText: 'æ›´å¤§(å«ç›¸ç­‰)', denyButtonText: 'æ›´å°', confirmButtonColor: '#16a34a', denyButtonColor: '#dc2626', allowOutsideClick: false }).then((result) => { const guess = result.isConfirmed ? 'more' : 'less'; socket.emit('execute_attack', {roomId:myRid,userId:myId,boxA:selectedBoxes[0],boxB:selectedBoxes[1],guess:guess}); selectedBoxes = []; }); } } 
            else if(currentStrat===3) { inputs.innerHTML = "ç‚¹å‡»å¡ç‰Œè¿½è¸ª"; btn.classList.add('hidden'); } 
            else if(currentStrat===4) {
                const s4 = gd.s4;
                if (s4.stage === 1 || s4.stage === 3) { inputs.innerHTML = "ç‚¹å‡»å¡ç‰Œå¯»æ‰¾"; btn.classList.add('hidden'); } 
                else if (s4.stage === 4) { 
                    btn.classList.remove('hidden');
                    let count = 5; if(s4.wins === 1) count = 7; if(s4.wins === 2) count = 22; 
                    inputs.innerHTML = `å·²é€‰: <span class="text-yellow-400 font-bold">${selectedBoxes.length}</span> / ${count}`;
                    if(count===22) { 
                        btn.innerText = "ä¸€é”®æ å¤º"; 
                        btn.onclick = ()=>{ const all = Array.from({length:22},(_,i)=>i); socket.emit('s4_execute_pick', {roomId:myRid,userId:myId,pickIndices:all}); }; 
                    } else { 
                        if(selectedBoxes.length === count) {
                            btn.innerText = "ç¡®è®¤æ å¤º";
                            btn.className = "bg-red-600 hover:bg-red-500 text-white px-5 py-2 rounded-lg font-bold shadow animate-pulse";
                            btn.onclick = ()=>{ socket.emit('s4_execute_pick', {roomId:myRid,userId:myId,pickIndices:selectedBoxes}); selectedBoxes=[]; }; 
                        } else {
                            btn.innerText = `é€‰æ»¡${count}ä¸ª`;
                            btn.className = "bg-slate-700 text-slate-500 px-5 py-2 rounded-lg font-bold cursor-not-allowed";
                        }
                    } 
                }
            }
        }

        socket.on('strat3_hint', data => Swal.fire(`ç¬¬${data.count}æ¬¡å°è¯•`, `ç»“æœï¼š${data.hint}`, 'info'));
        socket.on('round_summary', data => { const trans = document.getElementById('round-transition'); const inner = document.getElementById('round-modal-inner'); const sub = document.getElementById('rt-sub'); trans.style.opacity = 1; inner.style.transform = 'scale(1)'; sub.innerHTML = `æœ¬è½®ç»“æŸ<br>é˜²å®ˆæ–¹å›æ”¶: ${data.refund}`; setTimeout(() => { trans.style.opacity = 0; inner.style.transform = 'scale(0)'; }, 3500); });
        
        socket.on('show_game_summary', data => {
            document.getElementById('round-transition').style.opacity = 0; 
            document.getElementById('summary-view').classList.remove('hidden');
            document.getElementById('game-board').classList.add('hidden'); 
            const tbody = document.getElementById('summary-tbody');
            tbody.innerHTML = data.history.map(h => {
                const isMeDef = h.defender === myId, isMeAtk = h.attacker === myId;
                const defName = isMeDef ? `<span class="text-green-400 font-bold">æˆ‘</span>` : h.defender;
                const atkName = isMeAtk ? `<span class="text-red-400 font-bold">æˆ‘</span>` : h.attacker;
                let change = ""; if (h.pnl_def !== 0) change += `å®ˆ${h.pnl_def > 0 ? '+' : ''}${h.pnl_def} `; if (h.pnl_atk !== 0) change += `æ”»${h.pnl_atk > 0 ? '+' : ''}${h.pnl_atk}`;
                return `<tr><td>R${h.round}</td><td>${atkName}<br><span class="text-[10px] text-slate-500">vs</span><br>${defName}</td><td><div class="text-[10px] text-slate-400">å®ˆ:R${h.rule}</div><div class="text-[10px] text-slate-400">æ”»:S${h.strat ? String.fromCharCode(64+h.strat) : '-'}</div></td><td>${h.result}</td><td class="font-mono ${change.includes('-') ? 'text-red-300' : 'text-green-300'} text-xs">${change}</td></tr>`;
            }).join('');
            document.getElementById('final-winner').innerText = data.winner;
            document.getElementById('final-myscore').innerText = data.scores[myId] || 0;
            document.getElementById('total-players').innerText = Object.keys(data.scores).length;
            let sec = 180; if(summaryTimerInt) clearInterval(summaryTimerInt);
            summaryTimerInt = setInterval(() => { sec--; document.getElementById('summary-timer').innerText = sec; if(sec <= 0) clearInterval(summaryTimerInt); }, 1000);
        });

        socket.on('update_confirm_count', count => { document.getElementById('confirm-count').innerText = count; });
        socket.on('reset_to_lobby', () => {
            if(summaryTimerInt) clearInterval(summaryTimerInt);
            document.getElementById('summary-view').classList.add('hidden');
            document.getElementById('game-stats').classList.add('hidden');
            selectedBoxes = []; currentStrat = 0; gameDataCache = {};
            document.getElementById('prep-screen').classList.remove('hidden');
            document.getElementById('btn-exit').classList.remove('hidden');
            document.getElementById('view-room').classList.remove('hidden');
            socket.emit('get_room_sync', {roomId: myRid});
        });
        function confirmSummary() {
            document.getElementById('btn-confirm-summary').disabled = true;
            document.getElementById('btn-confirm-summary').classList.add('btn-disabled');
            document.getElementById('btn-confirm-summary').innerText = "å·²ç¡®è®¤ï¼Œç­‰å¾…...";
            socket.emit('confirm_summary', {roomId: myRid, userId: myId});
        }
        function sendChat(){ const i=document.getElementById('chat-input'); if(i.value) { socket.emit('send_chat',{roomId:myRid,userId:myId,msg:i.value}); i.value=''; } }
        socket.on('chat_message', d=>{ const box = document.getElementById('chat-box'); box.innerHTML += `<div class="mb-1 break-words"><span class="${d.type==='info'?'text-yellow-400':'text-blue-400'} font-bold">${d.user}:</span> ${d.msg}</div>`; box.scrollTop = box.scrollHeight; if(d.type==='chat') { const dan = document.createElement('div'); dan.className='danmaku-item text-xl'; dan.innerText=d.msg; dan.style.top=10 + Math.random()*60+'%'; document.getElementById('danmaku-layer').appendChild(dan); setTimeout(()=>dan.remove(),10000); } });
        socket.on('error', d=>Swal.fire('Error',d.msg,'error'));
    </script>
</body>
</html>